{"version":3,"file":"location-legacy.6e0bfe25.js","sources":["../../node_modules/vant/es/composables/use-id.js","../../node_modules/vant/es/composables/use-route.js","../../node_modules/load-script/index.js","../../src/utils/storage.ts","../../src/utils/location.ts"],"sourcesContent":["import { getCurrentInstance } from 'vue';\nvar current = 0;\nexport function useId() {\n  var vm = getCurrentInstance();\n  var {\n    name = 'unknown'\n  } = (vm == null ? void 0 : vm.type) || {}; // keep jest snapshot stable\n\n  if (process.env.NODE_ENV === 'test') {\n    return name;\n  }\n\n  return name + \"-\" + ++current;\n}","/**\n * Vue Router support\n */\nimport { getCurrentInstance } from 'vue';\nexport var routeProps = {\n  to: [String, Object],\n  url: String,\n  replace: Boolean\n};\nexport function route(_ref) {\n  var {\n    to,\n    url,\n    replace,\n    $router: router\n  } = _ref;\n\n  if (to && router) {\n    router[replace ? 'replace' : 'push'](to);\n  } else if (url) {\n    replace ? location.replace(url) : location.href = url;\n  }\n}\nexport function useRoute() {\n  var vm = getCurrentInstance().proxy;\n  return () => route(vm);\n}","\nmodule.exports = function load (src, opts, cb) {\n  var head = document.head || document.getElementsByTagName('head')[0]\n  var script = document.createElement('script')\n\n  if (typeof opts === 'function') {\n    cb = opts\n    opts = {}\n  }\n\n  opts = opts || {}\n  cb = cb || function() {}\n\n  script.type = opts.type || 'text/javascript'\n  script.charset = opts.charset || 'utf8';\n  script.async = 'async' in opts ? !!opts.async : true\n  script.src = src\n\n  if (opts.attrs) {\n    setAttributes(script, opts.attrs)\n  }\n\n  if (opts.text) {\n    script.text = '' + opts.text\n  }\n\n  var onend = 'onload' in script ? stdOnEnd : ieOnEnd\n  onend(script, cb)\n\n  // some good legacy browsers (firefox) fail the 'in' detection above\n  // so as a fallback we always set onload\n  // old IE will ignore this and new IE will set onload\n  if (!script.onload) {\n    stdOnEnd(script, cb);\n  }\n\n  head.appendChild(script)\n}\n\nfunction setAttributes(script, attrs) {\n  for (var attr in attrs) {\n    script.setAttribute(attr, attrs[attr]);\n  }\n}\n\nfunction stdOnEnd (script, cb) {\n  script.onload = function () {\n    this.onerror = this.onload = null\n    cb(null, script)\n  }\n  script.onerror = function () {\n    // this.onload = null here is necessary\n    // because even IE9 works not like others\n    this.onerror = this.onload = null\n    cb(new Error('Failed to load ' + this.src), script)\n  }\n}\n\nfunction ieOnEnd (script, cb) {\n  script.onreadystatechange = function () {\n    if (this.readyState != 'complete' && this.readyState != 'loaded') return\n    this.onreadystatechange = null\n    cb(null, script) // there is no way to catch loading errors in IE8\n  }\n}\n","export function storageFactory(storage: Storage) {\n  let inMemoryStorage: any = {}\n  function isSupported() {\n    try {\n      const testKey = '__some_random_key_you_are_not_going_to_use__'\n      storage.setItem(testKey, testKey)\n      storage.removeItem(testKey)\n      return true\n    } catch (e) {\n      return false\n    }\n  }\n\n  function clear() {\n    if (isSupported()) {\n      storage.clear()\n    } else {\n      inMemoryStorage = {}\n    }\n  }\n\n  function getItem(name: string) {\n    if (isSupported()) {\n      return JSON.parse(storage.getItem(name) as string)\n    }\n    if (inMemoryStorage.hasOwnProperty(name)) {\n      return inMemoryStorage[name]\n    }\n    return null\n  }\n\n  function key(index: any) {\n    if (isSupported()) {\n      return storage.key(index)\n    } else {\n      return Object.keys(inMemoryStorage)[index] || null\n    }\n  }\n\n  function removeItem(name: string) {\n    if (isSupported()) {\n      storage.removeItem(name)\n    } else {\n      delete inMemoryStorage[name]\n    }\n  }\n\n  function setItem(name: string, value: any) {\n    if (isSupported()) {\n      storage.setItem(name, JSON.stringify(value))\n    } else {\n      inMemoryStorage[name] = String(value)\n    }\n  }\n\n  return {\n    getItem,\n    setItem,\n    removeItem,\n    clear,\n    key\n  }\n}\n\nexport const localStore = storageFactory(localStorage)\nexport const sessionStore = storageFactory(sessionStorage)\n","import loadScript from 'load-script'\nimport { localStore } from './storage'\n\nexport interface LocationType {\n  cityId: string\n  cityName: string\n  lat: string\n  lng: string\n  time?: number\n}\n\nasync function getH5Location(): Promise<LocationType | null> {\n  /* 加载高德地图API */\n  function getAMap() {\n    return new Promise((resolve, reject) => {\n      if (window.AMap && window.AMap.Map) {\n        resolve(window.AMap)\n      } else {\n        loadScript(\n          '//webapi.amap.com/maps?v=1.4.15&key=c740e64858e21be917b7a68d264f60bd&callback=onAMapLoaded',\n          (err: any) => {\n            if (err) {\n              reject(null)\n            } else {\n              window.onAMapLoaded = () => {\n                resolve(window.AMap)\n              }\n            }\n          }\n        )\n      }\n    })\n  }\n  const AMap: any | null = await getAMap()\n  return new Promise((resolve, reject) => {\n    try {\n      if (AMap) {\n        /* https://developer.amap.com/api/javascript-api/reference/location */\n        const map = new AMap.Map('iCenter')\n        map.plugin('AMap.Geolocation', () => {\n          const geolocation = new AMap.Geolocation({\n            enableHighAccuracy: true, // 是否使用高精度定位，默认:true\n            timeout: 5000, // 超过5秒后停止定位，默认：无穷大\n            buttonOffset: new AMap.Pixel(10, 20), // 定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)\n            zoomToAccuracy: true, // 定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false\n            buttonPosition: 'RB'\n          })\n          geolocation.getCurrentPosition()\n          AMap.event.addListener(geolocation, 'complete', (data: any) => {\n            console.log(data)\n            const adcode = data?.addressComponent?.adcode\n            const cityId = adcode ? `${adcode.slice(0, 4)}00` : ''\n            const city = data?.addressComponent?.city\n            const cityName = city ? city.replace('市', '') : ''\n            const lat = data?.position?.lat\n            const lng = data?.position?.lng\n            const obj: LocationType = {\n              cityId,\n              cityName,\n              lat,\n              lng\n            }\n            resolve(cityId ? obj : null)\n          }) // 返回定位信息\n          AMap.event.addListener(geolocation, 'error', (error: any) => {\n            console.log(error)\n            reject(null)\n          }) // 返回定位出错信息\n        })\n      } else {\n        resolve(null)\n      }\n    } catch (e) {\n      console.log(e)\n      reject(null)\n    }\n  })\n}\n\nconst STORAGE_KEY_LOCATION = 'location'\n\nexport async function getLocation(cache = 30): Promise<LocationType | null> {\n  try {\n    const locationStorage = localStore.getItem(STORAGE_KEY_LOCATION)\n    const now = Date.now()\n    let res: LocationType | null\n    if (locationStorage) {\n      if (now - locationStorage.time < cache * 60 * 1000) {\n        // 存储30分钟\n        res = locationStorage\n      } else {\n        res = await getH5Location()\n      }\n    } else {\n      res = await getH5Location()\n    }\n    if (res) {\n      localStore.setItem(STORAGE_KEY_LOCATION, {\n        ...res,\n        time: Date.now()\n      })\n    }\n    return res\n  } catch (e) {\n    return null\n  }\n}\n"],"names":["vm","getCurrentInstance","type","name","current","proxy","route","to","String","Object","url","replace","Boolean","_ref","router","$router","location","href","loadScript","src","opts","cb","head","document","getElementsByTagName","script","createElement","charset","async","attrs","attr","setAttribute","setAttributes","text","stdOnEnd","ieOnEnd","onload","appendChild","this","onerror","Error","onreadystatechange","readyState","localStore","storage","inMemoryStorage","testKey","setItem","removeItem","e","getItem","isSupported","JSON","parse","hasOwnProperty","value","stringify","clear","key","index","keys","storageFactory","localStorage","Promise","resolve","reject","window","AMap","Map","err","onAMapLoaded","getAMap","plugin","geolocation","Geolocation","enableHighAccuracy","timeout","buttonOffset","Pixel","zoomToAccuracy","buttonPosition","getCurrentPosition","event","addListener","data","log","adcode","addressComponent","_data$addressComponen","cityId","slice","city","_data$addressComponen2","cityName","lat","position","_data$position","lng","_data$position2","error","STORAGE_KEY_LOCATION","cache","locationStorage","now","Date","time","getH5Location","res"],"mappings":"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"}