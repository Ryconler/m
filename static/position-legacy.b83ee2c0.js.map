{"version":3,"file":"position-legacy.b83ee2c0.js","sources":["../../node_modules/load-script/index.js","../../src/utils/position.ts"],"sourcesContent":["\nmodule.exports = function load (src, opts, cb) {\n  var head = document.head || document.getElementsByTagName('head')[0]\n  var script = document.createElement('script')\n\n  if (typeof opts === 'function') {\n    cb = opts\n    opts = {}\n  }\n\n  opts = opts || {}\n  cb = cb || function() {}\n\n  script.type = opts.type || 'text/javascript'\n  script.charset = opts.charset || 'utf8';\n  script.async = 'async' in opts ? !!opts.async : true\n  script.src = src\n\n  if (opts.attrs) {\n    setAttributes(script, opts.attrs)\n  }\n\n  if (opts.text) {\n    script.text = '' + opts.text\n  }\n\n  var onend = 'onload' in script ? stdOnEnd : ieOnEnd\n  onend(script, cb)\n\n  // some good legacy browsers (firefox) fail the 'in' detection above\n  // so as a fallback we always set onload\n  // old IE will ignore this and new IE will set onload\n  if (!script.onload) {\n    stdOnEnd(script, cb);\n  }\n\n  head.appendChild(script)\n}\n\nfunction setAttributes(script, attrs) {\n  for (var attr in attrs) {\n    script.setAttribute(attr, attrs[attr]);\n  }\n}\n\nfunction stdOnEnd (script, cb) {\n  script.onload = function () {\n    this.onerror = this.onload = null\n    cb(null, script)\n  }\n  script.onerror = function () {\n    // this.onload = null here is necessary\n    // because even IE9 works not like others\n    this.onerror = this.onload = null\n    cb(new Error('Failed to load ' + this.src), script)\n  }\n}\n\nfunction ieOnEnd (script, cb) {\n  script.onreadystatechange = function () {\n    if (this.readyState != 'complete' && this.readyState != 'loaded') return\n    this.onreadystatechange = null\n    cb(null, script) // there is no way to catch loading errors in IE8\n  }\n}\n","import { StorageKeys } from '@/constant/storage'\nimport loadScript from 'load-script'\nimport { PositionType } from 'types/position'\nimport { localStore } from './storage'\n\nasync function getH5Position(): Promise<PositionType | null> {\n  /* 加载高德地图API */\n  function getAMap() {\n    return new Promise((resolve, reject) => {\n      if (window.AMap && window.AMap.Map) {\n        resolve(window.AMap)\n      } else {\n        loadScript(\n          '//webapi.amap.com/maps?v=1.4.15&key=c740e64858e21be917b7a68d264f60bd&callback=onAMapLoaded',\n          (err: any) => {\n            if (err) {\n              reject(null)\n            } else {\n              window.onAMapLoaded = () => {\n                resolve(window.AMap)\n              }\n            }\n          }\n        )\n      }\n    })\n  }\n  const AMap: any | null = await getAMap()\n  return new Promise((resolve, reject) => {\n    try {\n      if (AMap) {\n        /* https://developer.amap.com/api/javascript-api/reference/location */\n        const map = new AMap.Map('iCenter')\n        map.plugin('AMap.Geolocation', () => {\n          const geolocation = new AMap.Geolocation({\n            enableHighAccuracy: true, // 是否使用高精度定位，默认:true\n            timeout: 5000, // 超过5秒后停止定位，默认：无穷大\n            buttonOffset: new AMap.Pixel(10, 20), // 定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)\n            zoomToAccuracy: true, // 定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false\n            buttonPosition: 'RB'\n          })\n          geolocation.getCurrentPosition()\n          AMap.event.addListener(geolocation, 'complete', (data: any) => {\n            console.log('geolocation', data)\n            if (data && data.addressComponent && data.position) {\n              const cityId = data.addressComponent.adcode\n              const city = data.addressComponent.city\n              const cityName = city ? city.replace('市', '') : ''\n              const lat = data.position.lat\n              const lng = data.position.lng\n              const obj: PositionType = {\n                cityId,\n                cityName,\n                lat,\n                lng\n              }\n              resolve(cityId ? obj : null)\n            } else {\n              resolve(null)\n            }\n          }) // 返回定位信息\n          AMap.event.addListener(geolocation, 'error', (error: any) => {\n            console.error('geolocation error', error)\n            reject(null)\n          }) // 返回定位出错信息\n        })\n      } else {\n        resolve(null)\n      }\n    } catch (e) {\n      console.error(e)\n      reject(null)\n    }\n  })\n}\n\nexport async function getPosition(cache = 30): Promise<PositionType | null> {\n  try {\n    const positionStorage = localStore.getItem(StorageKeys.Position)\n    const now = Date.now()\n    let res: PositionType | null\n    if (positionStorage) {\n      if (now - positionStorage.time < cache * 60 * 1000) {\n        // 存储30分钟\n        res = positionStorage\n      } else {\n        res = await getH5Position()\n      }\n    } else {\n      res = await getH5Position()\n    }\n    if (res) {\n      localStore.setItem(StorageKeys.Position, {\n        ...res,\n        time: Date.now()\n      })\n    }\n    return res\n  } catch (e) {\n    return null\n  }\n}\n"],"names":["loadScript","src","opts","cb","head","document","getElementsByTagName","script","createElement","type","charset","async","attrs","attr","setAttribute","setAttributes","text","stdOnEnd","ieOnEnd","onload","appendChild","this","onerror","Error","onreadystatechange","readyState","Promise","resolve","reject","window","AMap","Map","err","onAMapLoaded","getAMap","plugin","geolocation","Geolocation","enableHighAccuracy","timeout","buttonOffset","Pixel","zoomToAccuracy","buttonPosition","getCurrentPosition","event","addListener","data","log","addressComponent","position","cityId","adcode","city","cityName","replace","lat","lng","error","e","cache","positionStorage","localStore","getItem","StorageKeys","Position","now","Date","time","getH5Position","res","setItem"],"mappings":"mvCACAA,EAAiB,SAAeC,EAAKC,EAAMC,GACzC,IAAIC,EAAOC,SAASD,MAAQC,SAASC,qBAAqB,QAAQ,GAC9DC,EAASF,SAASG,cAAc,UAEhB,mBAATN,IACTC,EAAKD,EACLA,EAAO,IAGTA,EAAOA,GAAQ,GACfC,EAAKA,GAAM,aAEXI,EAAOE,KAAOP,EAAKO,MAAQ,kBAC3BF,EAAOG,QAAUR,EAAKQ,SAAW,OACjCH,EAAOI,QAAQ,UAAWT,MAASA,EAAKS,MACxCJ,EAAON,IAAMA,EAETC,EAAKU,OAqBX,SAAuBL,EAAQK,GAC7B,IAAK,IAAIC,KAAQD,EACfL,EAAOO,aAAaD,EAAMD,EAAMC,IAtBhCE,CAAcR,EAAQL,EAAKU,OAGzBV,EAAKc,OACPT,EAAOS,KAAO,GAAKd,EAAKc,OAGd,WAAYT,EAASU,EAAWC,GACtCX,EAAQJ,GAKTI,EAAOY,QACVF,EAASV,EAAQJ,GAGnBC,EAAKgB,YAAYb,IASnB,SAASU,EAAUV,EAAQJ,GACzBI,EAAOY,OAAS,WACdE,KAAKC,QAAUD,KAAKF,OAAS,KAC7BhB,EAAG,KAAMI,IAEXA,EAAOe,QAAU,WAGfD,KAAKC,QAAUD,KAAKF,OAAS,KAC7BhB,EAAG,IAAIoB,MAAM,kBAAoBF,KAAKpB,KAAMM,IAIhD,SAASW,EAASX,EAAQJ,GACxBI,EAAOiB,mBAAqB,WACH,YAAnBH,KAAKI,YAA+C,UAAnBJ,KAAKI,aAC1CJ,KAAKG,mBAAqB,KAC1BrB,EAAG,KAAMI,kGCzDb,oIAGemB,SAAQ,SAACC,EAASC,GACvBC,OAAOC,MAAQD,OAAOC,KAAKC,MACrBF,OAAOC,QAGb,8FACA,SAACE,GACKA,IACK,aAEAC,aAAe,aACZJ,OAAOC,uBAQEI,kBAAzBJ,2BACC,IAAIJ,SAAQ,SAACC,EAASC,UAErBE,EAEU,IAAIA,EAAKC,IAAI,WACrBI,OAAO,oBAAoB,eACvBC,EAAc,IAAIN,EAAKO,YAAY,CACvCC,oBAAoB,EACpBC,QAAS,IACTC,aAAc,IAAIV,EAAKW,MAAM,GAAI,IACjCC,gBAAgB,EAChBC,eAAgB,SAENC,uBACPC,MAAMC,YAAYV,EAAa,YAAY,SAACW,cACvCC,IAAI,cAAeD,GACvBA,GAAQA,EAAKE,kBAAoBF,EAAKG,SAAU,KAC5CC,EAASJ,EAAKE,iBAAiBG,OAC/BC,EAAON,EAAKE,iBAAiBI,KAC7BC,EAAWD,EAAOA,EAAKE,QAAQ,IAAK,IAAM,GAC1CC,EAAMT,EAAKG,SAASM,IACpBC,EAAMV,EAAKG,SAASO,MAOlBN,EANkB,CACxBA,OAAAA,EACAG,SAAAA,EACAE,IAAAA,EACAC,IAAAA,GAEqB,aAEf,WAGPZ,MAAMC,YAAYV,EAAa,SAAS,SAACsB,WACpCA,MAAM,oBAAqBA,KAC5B,mBAIH,YAEHC,WACCD,MAAMC,KACP,sPAKqBC,iCAAQ,YAEhCC,EAAkBC,EAAWC,QAAQC,EAAYC,UACjDC,EAAMC,KAAKD,OAEbL,wBACEK,EAAML,EAAgBO,KAAe,GAARR,EAAa,uBAEtCC,0CAEMQ,sEAGFA,oCAEVC,KACSC,QAAQP,EAAYC,gBAC1BK,OACHF,KAAMD,KAAKD,2BAGRI,8DAEA"}