{"version":3,"file":"location.4456e9f0.js","sources":["../../node_modules/vant/es/composables/use-route.js","../../node_modules/vant/es/composables/use-id.js","../../node_modules/load-script/index.js","../../src/utils/storage.ts","../../src/utils/location.ts"],"sourcesContent":["/**\n * Vue Router support\n */\nimport { getCurrentInstance } from 'vue';\nexport var routeProps = {\n  to: [String, Object],\n  url: String,\n  replace: Boolean\n};\nexport function route(_ref) {\n  var {\n    to,\n    url,\n    replace,\n    $router: router\n  } = _ref;\n\n  if (to && router) {\n    router[replace ? 'replace' : 'push'](to);\n  } else if (url) {\n    replace ? location.replace(url) : location.href = url;\n  }\n}\nexport function useRoute() {\n  var vm = getCurrentInstance().proxy;\n  return () => route(vm);\n}","import { getCurrentInstance } from 'vue';\nvar current = 0;\nexport function useId() {\n  var vm = getCurrentInstance();\n  var {\n    name = 'unknown'\n  } = (vm == null ? void 0 : vm.type) || {}; // keep jest snapshot stable\n\n  if (process.env.NODE_ENV === 'test') {\n    return name;\n  }\n\n  return name + \"-\" + ++current;\n}","\nmodule.exports = function load (src, opts, cb) {\n  var head = document.head || document.getElementsByTagName('head')[0]\n  var script = document.createElement('script')\n\n  if (typeof opts === 'function') {\n    cb = opts\n    opts = {}\n  }\n\n  opts = opts || {}\n  cb = cb || function() {}\n\n  script.type = opts.type || 'text/javascript'\n  script.charset = opts.charset || 'utf8';\n  script.async = 'async' in opts ? !!opts.async : true\n  script.src = src\n\n  if (opts.attrs) {\n    setAttributes(script, opts.attrs)\n  }\n\n  if (opts.text) {\n    script.text = '' + opts.text\n  }\n\n  var onend = 'onload' in script ? stdOnEnd : ieOnEnd\n  onend(script, cb)\n\n  // some good legacy browsers (firefox) fail the 'in' detection above\n  // so as a fallback we always set onload\n  // old IE will ignore this and new IE will set onload\n  if (!script.onload) {\n    stdOnEnd(script, cb);\n  }\n\n  head.appendChild(script)\n}\n\nfunction setAttributes(script, attrs) {\n  for (var attr in attrs) {\n    script.setAttribute(attr, attrs[attr]);\n  }\n}\n\nfunction stdOnEnd (script, cb) {\n  script.onload = function () {\n    this.onerror = this.onload = null\n    cb(null, script)\n  }\n  script.onerror = function () {\n    // this.onload = null here is necessary\n    // because even IE9 works not like others\n    this.onerror = this.onload = null\n    cb(new Error('Failed to load ' + this.src), script)\n  }\n}\n\nfunction ieOnEnd (script, cb) {\n  script.onreadystatechange = function () {\n    if (this.readyState != 'complete' && this.readyState != 'loaded') return\n    this.onreadystatechange = null\n    cb(null, script) // there is no way to catch loading errors in IE8\n  }\n}\n","export function storageFactory(storage: Storage) {\n  let inMemoryStorage: any = {}\n  function isSupported() {\n    try {\n      const testKey = '__some_random_key_you_are_not_going_to_use__'\n      storage.setItem(testKey, testKey)\n      storage.removeItem(testKey)\n      return true\n    } catch (e) {\n      return false\n    }\n  }\n\n  function clear() {\n    if (isSupported()) {\n      storage.clear()\n    } else {\n      inMemoryStorage = {}\n    }\n  }\n\n  function getItem(name: string) {\n    if (isSupported()) {\n      return JSON.parse(storage.getItem(name) as string)\n    }\n    if (inMemoryStorage.hasOwnProperty(name)) {\n      return inMemoryStorage[name]\n    }\n    return null\n  }\n\n  function key(index: any) {\n    if (isSupported()) {\n      return storage.key(index)\n    } else {\n      return Object.keys(inMemoryStorage)[index] || null\n    }\n  }\n\n  function removeItem(name: string) {\n    if (isSupported()) {\n      storage.removeItem(name)\n    } else {\n      delete inMemoryStorage[name]\n    }\n  }\n\n  function setItem(name: string, value: any) {\n    if (isSupported()) {\n      storage.setItem(name, JSON.stringify(value))\n    } else {\n      inMemoryStorage[name] = String(value)\n    }\n  }\n\n  return {\n    getItem,\n    setItem,\n    removeItem,\n    clear,\n    key\n  }\n}\n\nexport const localStore = storageFactory(localStorage)\nexport const sessionStore = storageFactory(sessionStorage)\n","import loadScript from 'load-script'\nimport { localStore } from './storage'\n\nexport interface LocationType {\n  cityId: string\n  cityName: string\n  lat: string\n  lng: string\n  time?: number\n}\n\nasync function getH5Location(): Promise<LocationType | null> {\n  /* 加载高德地图API */\n  function getAMap() {\n    return new Promise((resolve, reject) => {\n      if (window.AMap && window.AMap.Map) {\n        resolve(window.AMap)\n      } else {\n        loadScript(\n          '//webapi.amap.com/maps?v=1.4.15&key=c740e64858e21be917b7a68d264f60bd&callback=onAMapLoaded',\n          (err: any) => {\n            if (err) {\n              reject(null)\n            } else {\n              window.onAMapLoaded = () => {\n                resolve(window.AMap)\n              }\n            }\n          }\n        )\n      }\n    })\n  }\n  const AMap: any | null = await getAMap()\n  return new Promise((resolve, reject) => {\n    try {\n      if (AMap) {\n        /* https://developer.amap.com/api/javascript-api/reference/location */\n        const map = new AMap.Map('iCenter')\n        map.plugin('AMap.Geolocation', () => {\n          const geolocation = new AMap.Geolocation({\n            enableHighAccuracy: true, // 是否使用高精度定位，默认:true\n            timeout: 5000, // 超过5秒后停止定位，默认：无穷大\n            buttonOffset: new AMap.Pixel(10, 20), // 定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)\n            zoomToAccuracy: true, // 定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false\n            buttonPosition: 'RB'\n          })\n          geolocation.getCurrentPosition()\n          AMap.event.addListener(geolocation, 'complete', (data: any) => {\n            console.log(data)\n            const adcode = data?.addressComponent?.adcode\n            const cityId = adcode ? `${adcode.slice(0, 4)}00` : ''\n            const city = data?.addressComponent?.city\n            const cityName = city ? city.replace('市', '') : ''\n            const lat = data?.position?.lat\n            const lng = data?.position?.lng\n            const obj: LocationType = {\n              cityId,\n              cityName,\n              lat,\n              lng\n            }\n            resolve(cityId ? obj : null)\n          }) // 返回定位信息\n          AMap.event.addListener(geolocation, 'error', (error: any) => {\n            console.log(error)\n            reject(null)\n          }) // 返回定位出错信息\n        })\n      } else {\n        resolve(null)\n      }\n    } catch (e) {\n      console.log(e)\n      reject(null)\n    }\n  })\n}\n\nconst STORAGE_KEY_LOCATION = 'location'\n\nexport async function getLocation(cache = 30): Promise<LocationType | null> {\n  try {\n    const locationStorage = localStore.getItem(STORAGE_KEY_LOCATION)\n    const now = Date.now()\n    let res: LocationType | null\n    if (locationStorage) {\n      if (now - locationStorage.time < cache * 60 * 1000) {\n        // 存储30分钟\n        res = locationStorage\n      } else {\n        res = await getH5Location()\n      }\n    } else {\n      res = await getH5Location()\n    }\n    if (res) {\n      localStore.setItem(STORAGE_KEY_LOCATION, {\n        ...res,\n        time: Date.now()\n      })\n    }\n    return res\n  } catch (e) {\n    return null\n  }\n}\n"],"names":["routeProps","to","String","Object","url","replace","Boolean","_ref","$router","router","location","href","vm","getCurrentInstance","proxy","route","current","name","type","script","cb","onload","onerror","this","Error","src","onreadystatechange","readyState","localStore","storage","inMemoryStorage","testKey","setItem","removeItem","e","getItem","isSupported","JSON","parse","hasOwnProperty","value","stringify","clear","key","index","keys","storageFactory","localStorage","AMap","Promise","resolve","reject","opts","head","window","Map","err","onAMapLoaded","document","getElementsByTagName","createElement","charset","async","attrs","attr","setAttribute","text","stdOnEnd","ieOnEnd","appendChild","plugin","geolocation","Geolocation","enableHighAccuracy","timeout","buttonOffset","Pixel","zoomToAccuracy","buttonPosition","getCurrentPosition","event","addListener","data","log","adcode","addressComponent","cityId","slice","city","cityName","lat","position","lng","error","cache","locationStorage","now","Date","res","time","getH5Location"],"mappings":"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"}