{"version":3,"file":"Search.c845c17c.js","sources":["../../node_modules/load-script/index.js","../../src/utils/position.ts","../../src/composables/common.ts","../../src/views/search/Search.vue"],"sourcesContent":["\nmodule.exports = function load (src, opts, cb) {\n  var head = document.head || document.getElementsByTagName('head')[0]\n  var script = document.createElement('script')\n\n  if (typeof opts === 'function') {\n    cb = opts\n    opts = {}\n  }\n\n  opts = opts || {}\n  cb = cb || function() {}\n\n  script.type = opts.type || 'text/javascript'\n  script.charset = opts.charset || 'utf8';\n  script.async = 'async' in opts ? !!opts.async : true\n  script.src = src\n\n  if (opts.attrs) {\n    setAttributes(script, opts.attrs)\n  }\n\n  if (opts.text) {\n    script.text = '' + opts.text\n  }\n\n  var onend = 'onload' in script ? stdOnEnd : ieOnEnd\n  onend(script, cb)\n\n  // some good legacy browsers (firefox) fail the 'in' detection above\n  // so as a fallback we always set onload\n  // old IE will ignore this and new IE will set onload\n  if (!script.onload) {\n    stdOnEnd(script, cb);\n  }\n\n  head.appendChild(script)\n}\n\nfunction setAttributes(script, attrs) {\n  for (var attr in attrs) {\n    script.setAttribute(attr, attrs[attr]);\n  }\n}\n\nfunction stdOnEnd (script, cb) {\n  script.onload = function () {\n    this.onerror = this.onload = null\n    cb(null, script)\n  }\n  script.onerror = function () {\n    // this.onload = null here is necessary\n    // because even IE9 works not like others\n    this.onerror = this.onload = null\n    cb(new Error('Failed to load ' + this.src), script)\n  }\n}\n\nfunction ieOnEnd (script, cb) {\n  script.onreadystatechange = function () {\n    if (this.readyState != 'complete' && this.readyState != 'loaded') return\n    this.onreadystatechange = null\n    cb(null, script) // there is no way to catch loading errors in IE8\n  }\n}\n","import { StorageKeys } from '@/constant/storage'\nimport loadScript from 'load-script'\nimport { PositionType } from 'types/position'\nimport { localStore } from './storage'\n\nasync function getH5Position(): Promise<PositionType | null> {\n  /* 加载高德地图API */\n  function getAMap() {\n    return new Promise((resolve, reject) => {\n      if (window.AMap && window.AMap.Map) {\n        resolve(window.AMap)\n      } else {\n        loadScript(\n          '//webapi.amap.com/maps?v=1.4.15&key=c740e64858e21be917b7a68d264f60bd&callback=onAMapLoaded',\n          (err: any) => {\n            if (err) {\n              reject(null)\n            } else {\n              window.onAMapLoaded = () => {\n                resolve(window.AMap)\n              }\n            }\n          }\n        )\n      }\n    })\n  }\n  const AMap: any | null = await getAMap()\n  return new Promise((resolve, reject) => {\n    try {\n      if (AMap) {\n        /* https://developer.amap.com/api/javascript-api/reference/location */\n        const map = new AMap.Map('iCenter')\n        map.plugin('AMap.Geolocation', () => {\n          const geolocation = new AMap.Geolocation({\n            enableHighAccuracy: true, // 是否使用高精度定位，默认:true\n            timeout: 5000, // 超过5秒后停止定位，默认：无穷大\n            buttonOffset: new AMap.Pixel(10, 20), // 定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)\n            zoomToAccuracy: true, // 定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false\n            buttonPosition: 'RB'\n          })\n          geolocation.getCurrentPosition()\n          AMap.event.addListener(geolocation, 'complete', (data: any) => {\n            console.log('geolocation', data)\n            if (data && data.addressComponent && data.position) {\n              const cityId = data.addressComponent.adcode\n              const city = data.addressComponent.city\n              const cityName = city ? city.replace('市', '') : ''\n              const lat = data.position.lat\n              const lng = data.position.lng\n              const obj: PositionType = {\n                cityId,\n                cityName,\n                lat,\n                lng\n              }\n              resolve(cityId ? obj : null)\n            } else {\n              resolve(null)\n            }\n          }) // 返回定位信息\n          AMap.event.addListener(geolocation, 'error', (error: any) => {\n            console.error('geolocation error', error)\n            reject(null)\n          }) // 返回定位出错信息\n        })\n      } else {\n        resolve(null)\n      }\n    } catch (e) {\n      console.error(e)\n      reject(null)\n    }\n  })\n}\n\nexport async function getPosition(cache = 30): Promise<PositionType | null> {\n  try {\n    const positionStorage = localStore.getItem(StorageKeys.Position)\n    const now = Date.now()\n    let res: PositionType | null\n    if (positionStorage) {\n      if (now - positionStorage.time < cache * 60 * 1000) {\n        // 存储30分钟\n        res = positionStorage\n      } else {\n        res = await getH5Position()\n      }\n    } else {\n      res = await getH5Position()\n    }\n    if (res) {\n      localStore.setItem(StorageKeys.Position, {\n        ...res,\n        time: Date.now()\n      })\n    }\n    return res\n  } catch (e) {\n    return null\n  }\n}\n","import { DefaultCity } from '@/constant/city'\nimport { CookieKeys } from '@/constant/storage'\nimport { getPosition, getSelectCity, setSelectCity } from '@/utils'\nimport jsCookie from 'js-cookie'\nimport { CityType } from 'types/city'\nimport { PositionType } from 'types/position'\nimport { onMounted, Ref, ref } from 'vue'\n\n/* 获取选择城市、定位等信息 */\nexport const getLocation = () => {\n  const position: Ref<PositionType | null> = ref(null)\n  const cityInfo: Ref<CityType> = ref(DefaultCity)\n  const locationLoaded = ref(false) //选择城市与定位是否均获取完毕，可判断是否可以开始需要传参城市与定位的请求\n  onMounted(async () => {\n    const cookieCity = jsCookie.get(CookieKeys.City)\n    /* 1、优先取公共城市选择页的city */\n    if (cookieCity) {\n      const iNList = cookieCity.split('_')\n      cityInfo.value = {\n        cityId: iNList[0],\n        cityName: decodeURIComponent(iNList[1])\n      }\n    } else {\n      /* 2、没有继续取服务前端的city_service */\n      const cookieCityService = await getSelectCity()\n      if (cookieCityService != null) {\n        cityInfo.value = cookieCityService\n      } else {\n        /* 3、再没有取定位城市 */\n        position.value = await getPosition()\n        if (position.value != null) {\n          cityInfo.value = {\n            cityId: position.value.cityId,\n            cityName: position.value.cityName\n          }\n        } else {\n          /* 4、定位也取不到取默认南京 */\n          cityInfo.value = DefaultCity\n        }\n      }\n    }\n    // 将服务前端的city_service保持同步\n    setSelectCity(cityInfo.value.cityId, cityInfo.value.cityName)\n    if (position.value == null) {\n      // 上面的操作没有用到定位时，异步获取定位，不影响titlebar的城市显示\n      getPosition().then(data => {\n        position.value = data\n        locationLoaded.value = true\n      })\n    } else {\n      locationLoaded.value = true\n    }\n  })\n  return { position, cityInfo, locationLoaded }\n}\n","<template>\n  <div class=\"search\">\n    <SearchBar is-searching></SearchBar>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport { getSelectCity, setSelectCity } from '@/utils'\nimport { onMounted, Ref, ref } from 'vue'\nimport { getLocation } from '@/composables/common'\nimport { DefaultCity } from '@/constant/city'\nimport { CityType } from 'types/city'\n\nconst selectCity: Ref<CityType> = ref(DefaultCity)\nonMounted(async () => {\n  const cookieCity = getSelectCity()\n  if (cookieCity) {\n    selectCity.value = cookieCity\n  } else {\n    const { position } = await getLocation()\n    if (position.value != null) {\n      selectCity.value = {\n        cityId: position.value.cityId,\n        cityName: position.value.cityName\n      }\n    } else {\n      selectCity.value = DefaultCity\n    }\n    setSelectCity(selectCity.value.cityId, selectCity.value.cityName)\n  }\n})\n</script>\n"],"names":["jsCookie"],"mappings":"s2BACA,GAAiB,SAAe,EAAK,EAAM,EAAI,CAC7C,GAAI,GAAO,SAAS,MAAQ,SAAS,qBAAqB,MAAM,EAAE,GAC9D,EAAS,SAAS,cAAc,QAAQ,EAE5C,AAAI,MAAO,IAAS,YAClB,GAAK,EACL,EAAO,IAGT,EAAO,GAAQ,GACf,EAAK,GAAM,UAAW,GAEtB,EAAO,KAAO,EAAK,MAAQ,kBAC3B,EAAO,QAAU,EAAK,SAAW,OACjC,EAAO,MAAQ,SAAW,GAAO,CAAC,CAAC,EAAK,MAAQ,GAChD,EAAO,IAAM,EAET,EAAK,OACP,EAAc,EAAQ,EAAK,KAAK,EAG9B,EAAK,MACP,GAAO,KAAO,GAAK,EAAK,MAG1B,GAAI,GAAQ,UAAY,GAAS,EAAW,EAC5C,EAAM,EAAQ,CAAE,EAKX,EAAO,QACV,EAAS,EAAQ,CAAE,EAGrB,EAAK,YAAY,CAAM,CACzB,EAEA,WAAuB,EAAQ,EAAO,CACpC,OAAS,KAAQ,GACf,EAAO,aAAa,EAAM,EAAM,EAAK,CAEzC,CAEA,WAAmB,EAAQ,EAAI,CAC7B,EAAO,OAAS,UAAY,CAC1B,KAAK,QAAU,KAAK,OAAS,KAC7B,EAAG,KAAM,CAAM,GAEjB,EAAO,QAAU,UAAY,CAG3B,KAAK,QAAU,KAAK,OAAS,KAC7B,EAAG,GAAI,OAAM,kBAAoB,KAAK,GAAG,EAAG,CAAM,EAEtD,CAEA,WAAkB,EAAQ,EAAI,CAC5B,EAAO,mBAAqB,UAAY,CACtC,AAAI,KAAK,YAAc,YAAc,KAAK,YAAc,UACxD,MAAK,mBAAqB,KAC1B,EAAG,KAAM,CAAM,GAEnB,CC3DA,YAA6D,4CAExC,OACV,IAAI,SAAQ,CAAC,EAAS,IAAW,CAClC,OAAO,MAAQ,OAAO,KAAK,MACrB,OAAO,IAAI,IAGjB,6FACA,AAAC,GAAa,CACR,IACK,IAAI,SAEJ,aAAe,IAAM,GAClB,OAAO,IAAI,GAI3B,EAEH,OAEG,GAAmB,KAAM,WACxB,IAAI,SAAQ,CAAC,EAAS,IAAW,IAClC,CACE,EAEU,GAAI,GAAK,IAAI,SAAS,EAC9B,OAAO,mBAAoB,IAAM,MAC7B,GAAc,GAAI,GAAK,YAAY,CACvC,mBAAoB,GACpB,QAAS,IACT,aAAc,GAAI,GAAK,MAAM,GAAI,EAAE,EACnC,eAAgB,GAChB,eAAgB,KACjB,IACW,uBACP,MAAM,YAAY,EAAa,WAAY,AAAC,GAAc,YACrD,IAAI,cAAe,CAAI,EAC3B,GAAQ,EAAK,kBAAoB,EAAK,SAAU,MAC5C,GAAS,EAAK,iBAAiB,OAC/B,EAAO,EAAK,iBAAiB,KAC7B,EAAW,EAAO,EAAK,QAAQ,SAAK,EAAE,EAAI,GAC1C,EAAM,EAAK,SAAS,IACpB,EAAM,EAAK,SAAS,MAOlB,EANkB,CACxB,SACA,WACA,MACA,OAEqB,IAAI,SAEnB,IAAI,EAEf,IACI,MAAM,YAAY,EAAa,QAAS,AAAC,GAAe,SACnD,MAAM,oBAAqB,CAAK,IACjC,IAAI,EACZ,EACF,IAEO,IAAI,QAEP,WACC,MAAM,CAAC,IACR,IAAI,GAEd,CACH,cAEkC,EAAQ,GAAkC,mCACtE,MACI,GAAkB,EAAW,QAAQ,EAAY,QAAQ,EACzD,EAAM,KAAK,SACb,SACA,GACE,EAAM,EAAgB,KAAO,EAAQ,GAAK,MAEtC,IAEA,KAAM,OAGR,KAAM,KAEV,KACS,QAAQ,EAAY,SAAU,OACpC,GADoC,CAEvC,KAAM,KAAK,OACZ,EAEI,QACA,SACA,MAEX,QC5Fa,GAAc,IAAM,MACzB,GAAqC,EAAI,IAAI,EAC7C,EAA0B,EAAI,CAAW,EACzC,EAAiB,EAAI,EAAK,WACtB,IAAY,+BACd,GAAaA,EAAS,IAAI,EAAW,IAAI,KAE3C,EAAY,MACR,GAAS,EAAW,MAAM,GAAG,IAC1B,MAAQ,CACf,OAAQ,EAAO,GACf,SAAU,mBAAmB,EAAO,EAAE,OAEnC,MAEC,GAAoB,KAAM,KAC5B,GAAqB,OACd,MAAQ,KAGR,MAAQ,KAAM,KACnB,EAAS,OAAS,OACX,MAAQ,CACf,OAAQ,EAAS,MAAM,OACvB,SAAU,EAAS,MAAM,YAIlB,MAAQ,KAKT,EAAS,MAAM,OAAQ,EAAS,MAAM,QAAQ,EACxD,EAAS,OAAS,SAEN,KAAK,GAAQ,GAChB,MAAQ,IACF,MAAQ,GACxB,IAEc,MAAQ,IAE1B,EACM,CAAE,WAAU,WAAU,iBAC/B,wCCzCM,GAA4B,EAAI,CAAW,WACvC,IAAY,6BACd,GAAa,OACf,IACS,MAAQ,MACd,MACC,CAAE,YAAa,KAAM,KACvB,EAAS,OAAS,OACT,MAAQ,CACjB,OAAQ,EAAS,MAAM,OACvB,SAAU,EAAS,MAAM,YAGhB,MAAQ,IAEP,EAAW,MAAM,OAAQ,EAAW,MAAM,QAAQ,IAEnE"}